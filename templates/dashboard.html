{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass">
                <div class="card-body">
                    <h2 class="card-title mb-1">Welcome, {{ current_user.username }}!</h2>
                    <p class="card-text text-secondary">Stay healthy and keep tracking your nutrition goals!</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4 mb-4">
        <!-- Chat with NutriBot Card -->
        <div class="col-lg-3 col-md-6">
            <div class="card glass h-100">
                <div class="card-body d-flex flex-column align-items-center">
                    <i class="fas fa-robot fa-3x mb-3 text-primary"></i>
                    <h5 class="card-title">Chat with NutriBot</h5>
                    <p class="card-text">Get instant answers about nutrition and food.</p>
                    <a href="{{ url_for('chat') }}" class="btn btn-primary mt-auto w-100">Start Chat</a>
                </div>
            </div>
        </div>

        <!-- Track Meal Card -->
        <div class="col-lg-3 col-md-6">
            <div class="card glass h-100">
                <div class="card-body d-flex flex-column align-items-center">
                    <i class="fas fa-apple-alt fa-3x mb-3 text-primary"></i>
                    <h5 class="card-title">Track Your Meal</h5>
                    <p class="card-text">Log, scan, and review your meals and food analysis.</p>
                    <a href="{{ url_for('track_meal') }}" class="btn btn-primary mt-auto w-100">Go to Tracker</a>
                </div>
            </div>
        </div>

        <!-- Today's Meals Card -->
        <div class="col-lg-3 col-md-6">
            <div class="card glass h-100">
                <div class="card-body d-flex flex-column align-items-center">
                    <i class="fas fa-utensils fa-3x mb-3 text-primary"></i>
                    <h5 class="card-title">Today's Meals</h5>
                    {% if meals %}
                        <ul class="list-unstyled mb-2">
                            {% for meal in meals|slice(0,2) %}
                            <li class="mb-2">
                                <strong>{{ meal.name }}</strong>
                                {% if meal.calories %}
                                <span class="text-secondary">({{ meal.calories }} kcal)</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        <a href="{{ url_for('track_meal') }}" class="btn btn-primary w-100">See All</a>
                    {% else %}
                        <p class="text-secondary">No meals logged today</p>
                        <a href="{{ url_for('track_meal') }}" class="btn btn-primary w-100">Add Meal</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Food Analysis Card -->
        <div class="col-lg-3 col-md-6">
            <div class="card glass h-100">
                <div class="card-body d-flex flex-column align-items-center">
                    <i class="fas fa-camera fa-3x mb-3 text-primary"></i>
                    <h5 class="card-title">Food Analysis</h5>
                    <p class="card-text">Analyze your food images for nutritional information.</p>
                    <a href="{{ url_for('analyze_food') }}" class="btn btn-primary mt-auto w-100">Analyze Food</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.text-primary {
    color: var(--cal-primary) !important;
}

.btn-primary {
    background-color: var(--cal-primary);
    border-color: var(--cal-primary);
}

.btn-primary:hover {
    background-color: #5a4db3;
    border-color: #5a4db3;
}

.text-secondary {
    color: var(--cal-text-secondary) !important;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image Upload Preview
    const foodImage = document.getElementById('foodImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = imagePreview.querySelector('img');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadButton = document.getElementById('uploadButton');
    
    foodImage.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            
            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showStatus('Please select an image file', 'warning');
                this.value = '';
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showStatus('Image size should be less than 5MB', 'warning');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.classList.remove('d-none');
                uploadStatus.classList.add('d-none');
            }
            reader.readAsDataURL(file);
        }
    });

    // Image Upload
    uploadButton.addEventListener('click', async function() {
        const imageFile = foodImage.files[0];
        
        if (!imageFile) {
            showStatus('Please select an image', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('image', imageFile);
        
        uploadButton.disabled = true;
        showStatus('Analyzing image...', 'info');
        
        try {
            const response = await fetch('/analyze_food_image', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showStatus(data.message || 'Analysis complete!', 'success');
                // Reload the page after a short delay to show the new analysis
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showStatus(data.error || 'Error analyzing image', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showStatus('Error uploading image. Please try again.', 'danger');
        } finally {
            uploadButton.disabled = false;
        }
    });

    function showStatus(message, type) {
        uploadStatus.textContent = message;
        uploadStatus.className = `alert alert-${type}`;
        uploadStatus.classList.remove('d-none');
    }
});
</script>
{% endblock %}